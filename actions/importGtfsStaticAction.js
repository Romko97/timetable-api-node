const gtfs = require('gtfs');
const mongoose = require('mongoose');
const timetableDb = require('../connections/timetableDb');

module.exports = async (req, res, next) => {

    const easyway_map = {"593":3546,"575":9097,"1033":222178,"634":1887,"632":1884,"638":1882,"637":1881,"648":167250,"612":1879,"611":1876,"610":1875,"609":1873,"608":1872,"54":1868,"60":222399,"17":3747,"94":3750,"528":2055,"491":17,"492":18,"493":19,"531":169632,"136":7,"138":5,"551":222413,"1029":222582,"540":167292,"548":4909,"550":35222,"538":167293,"537":53359,"445":4915,"441":167309,"440":4916,"449":4303,"451":4305,"453":4308,"454":4310,"457":4311,"418":222394,"459":222486,"458":29065,"456":4309,"455":4307,"452":4306,"450":4304,"448":167311,"446":4918,"442":4917,"443":167310,"553":4914,"552":53360,"539":4912,"541":4911,"545":4910,"549":167291,"533":4,"534":6,"532":9,"477":10,"476":11,"475":167285,"474":12,"47":2054,"18":3749,"15":3747,"16":3751,"14":222216,"7":3561,"615":1869,"616":1871,"613":1874,"618":1877,"617":1878,"614":222496,"636":1880,"631":1883,"633":1885,"635":1886,"576":9098,"595":199371,"69":152906,"649":5453,"650":168771,"652":222237,"1066":5451,"1069":37044,"1065":167338,"1064":5448,"1062":167339,"1051":184241,"1052":35223,"1054":167341,"1056":5439,"1045":167341,"1053":35224,"1057":5441,"1063":167345,"1058":167340,"1059":5448,"1061":5449,"1068":37043,"651":222236,"654":168772,"653":5454,"6":222298,"313":222490,"1191":41646,"589":3549,"591":199370,"590":5709,"588":5711,"586":174027,"53":222567,"110":222209,"113":832,"529":167281,"485":375,"486":373,"483":571,"480":167307,"559":573,"565":366,"430":364,"431":167315,"436":367,"508":369,"568":370,"479":167306,"481":372,"482":374,"484":376,"530":222266,"535":222169,"494":222205,"82":47048,"582":169430,"583":88648,"585":5710,"587":5708,"320":172133,"434":222165,"435":136637,"433":199381,"432":363,"131":377,"130":2617,"129":379,"128":382,"125":6046,"100":826,"114":827,"497":829,"496":207453,"189":222159,"191":189490,"190":222262,"96":830,"498":828,"124":167237,"127":6047,"133":381,"134":380,"135":378,"561":167314,"562":362,"563":360,"564":222170,"179":1631,"761":6850,"687":4745,"689":167270,"691":74290,"692":74288,"701":4729,"694":4728,"695":4726,"698":4723,"657":4722,"655":4720,"656":4721,"693":4724,"700":4725,"699":4727,"702":4730,"690":74287,"688":74289,"686":167271,"685":4746,"186":4743,"142":6322,"181":1632,"180":1630,"629":6848,"597":75004,"598":3559,"603":3556,"600":3555,"601":3550,"659":9100,"619":9103,"662":23699,"658":9102,"605":3551,"607":3552,"604":3554,"599":3557,"602":167252,"596":4908,"622":167268,"627":4904,"696":4744,"177":1640,"176":1638,"194":1636,"195":1634,"429":572,"403":167316,"419":7241,"420":7239,"412":167333,"376":7230,"379":1440,"380":7229,"397":167329,"400":172129,"410":167330,"409":222195,"399":172128,"398":9106,"394":167302,"423":7228,"378":167303,"413":167334,"421":7238,"408":167318,"404":167317,"478":167308,"196":1633,"192":1635,"175":1637,"178":7227,"426":7227,"122":384,"119":821,"167":387,"166":389,"115":817,"102":3746,"116":818,"169":388,"168":386,"121":822,"120":385,"444":222168,"424":170691,"111":222150,"42":2453,"46":8255,"557":2056,"556":167284,"65":222154,"45":7888,"217":167326,"219":1428,"24":1429,"25":1432,"369":143874,"372":1435,"365":7890,"363":7892,"282":7896,"284":7899,"311":222603,"268":7904,"270":7906,"269":7903,"267":7902,"278":7908,"252":4517,"245":167242,"242":2454,"57":2754,"40":3753,"13":222235,"156":192251,"536":2619,"147":984,"149":983,"680":222151,"681":4737,"682":4736,"683":4736,"163":51632,"157":157426,"160":157425,"159":157427,"158":157428,"162":51633,"141":15719,"183":4733,"182":4735,"77":4738,"253":161610,"30":2069,"80":581,"76":579,"558":577,"566":575,"428":574,"75":576,"567":578,"292":582,"240":222560,"241":2455,"243":222561,"249":222134,"272":174028,"273":9094,"229":80800,"288":80798,"199":9089,"203":25158,"201":9087,"213":10335,"377":1439,"279":7907,"287":7899,"214":7893,"215":7891,"373":1437,"374":167327,"371":167328,"370":1436,"210":161610,"198":9086,"202":9088,"204":25157,"200":9090,"230":80797,"228":80799,"274":9093,"289":9092,"231":53634,"236":53635,"95":167280,"314":222197,"315":167295,"518":9931,"524":222302,"513":9935,"512":169651,"44":9939,"470":9938,"526":9937,"515":9934,"525":222303,"521":9930,"316":167294,"1071":222163,"1067":5452,"1076":35225,"1074":184236,"1075":35226,"1073":5444,"1072":167344,"205":10336,"208":174030,"209":47055,"211":174031,"10":3564,"271":222141,"224":1434,"223":1433,"222":1431,"221":143872,"220":143873,"218":167326,"36":2072,"31":2073,"20":2075,"66":2057,"266":12396,"560":365,"126":32211,"554":75003,"275":169431,"265":12397,"667":167263,"573":13014,"59":2753,"354":23696,"32":2756,"705":222192,"646":167262,"647":21942,"571":13015,"666":167263,"663":224332,"283":7897,"216":7889,"356":7231,"86":816,"355":7232,"364":7894,"1118":222222,"1107":222218,"104":820,"101":824,"624":3545,"97":825,"98":823,"99":819,"1108":222217,"1184":14204,"212":10332,"402":167319,"401":167320,"33":14300,"38":167321,"132":76732,"173":167304,"171":15570,"49":16,"174":15571,"172":167305,"90":15714,"89":167273,"87":167277,"93":167276,"165":15718,"193":167272,"164":15717,"88":167275,"92":167274,"91":167278,"21":28515,"29":176954,"406":29067,"81":580,"1001":222174,"1010":222176,"1012":222530,"1014":16648,"1008":4523,"1023":222282,"1019":16646,"259":16643,"258":16641,"257":29064,"254":4520,"261":16642,"262":16644,"1018":16645,"1017":167240,"1015":16647,"1013":75778,"668":3542,"743":167352,"360":167352,"670":167267,"669":155570,"522":9929,"381":167301,"395":167298,"396":167296,"389":1446,"388":167300,"387":1444,"520":9928,"234":35220,"235":222264,"277":35219,"572":222132,"639":185557,"660":185531,"570":222131,"276":35219,"232":222263,"233":35221,"255":137767,"1003":4522,"1009":167239,"1002":4522,"490":2446,"487":2448,"11":222156,"12":222155,"592":167251,"488":222196,"489":2447,"415":20136,"1":222260,"471":222466,"64":2058,"79":835,"472":222465,"473":222265,"414":20137,"368":21938,"366":21937,"546":222290,"664":194460,"665":21346,"153":167286,"154":979,"151":978,"155":167287,"625":3545,"62":3563,"574":9099,"713":222392,"417":5714,"298":222553,"26":167246,"746":222414,"237":53636,"1060":5450,"50":2063,"51":2062,"19":2076,"85":50033,"1119":222225,"1183":14205,"1181":222359,"1182":222360,"1025":222390,"768":222166,"767":222167,"411":167332,"386":1443,"390":17440,"760":222559,"759":222558,"367":222273,"326":222161,"772":15569,"1180":88655,"295":88650,"1193":51561,"1194":51562,"1178":51564,"1177":51564,"1171":222422,"52":2061,"1077":222140,"256":207452,"48":14,"71":86499,"41":172132,"781":222463,"78":15,"661":3124,"505":2077,"678":222271,"675":3126,"674":3126,"673":167255,"676":3123,"584":222277,"580":222564,"581":3121,"579":3120,"672":167256,"671":167257,"630":3119,"640":2748,"642":167248,"23":2749,"3":2751,"2":2752,"61":2065,"58":2067,"63":2066,"286":2462,"251":222134,"248":2460,"247":2459,"250":14209,"74":2632,"35":2071,"34":2074,"37":222409,"28":2758,"43":2060,"27":2078,"467":222153,"466":2631,"555":2081,"527":2079,"511":2080,"465":2445,"499":2444,"469":2629,"468":2628,"293":2626,"294":2627,"517":2622,"516":2623,"519":2621,"501":2442,"500":2443,"502":2441,"504":2438,"679":222204,"503":2440,"569":371,"299":222554,"509":368,"510":167283,"375":1438,"391":167297,"384":1448,"382":1442,"708":222397,"73":4300,"792":222479,"793":222479,"285":7909,"776":222581,"775":222580,"774":222568,"773":222569,"1030":222583,"1031":77031,"1004":167238,"1186":14206,"1185":14207,"751":204331,"547":222462,"739":167249,"1024":222393,"1020":222283,"303":222402,"322":222401,"310":167353,"302":222403,"791":222469,"790":222468,"783":222471,"782":222470,"324":4303,"795":222472,"4":222480,"393":48340,"736":222552,"306":222533,"711":222412,"712":222412,"70":222433,"763":9100,"495":222205,"797":222474,"796":222476,"777":222578,"778":222579,"788":222500,"787":222485,"784":222497,"785":222498,"786":222485,"789":222500,"754":222484,"246":2458,"226":222449,"225":13737,"239":28517,"238":28516,"749":222210,"771":222487,"738":167251,"207":10333,"206":10334,"1021":222284,"1005":4524,"1007":4526,"109":167279,"108":156127,"107":3744,"106":3745,"103":3743,"105":3741,"359":167323,"357":4302,"72":4300,"800":222544,"439":7233,"362":7235,"358":167322,"9":167324,"1032":222177,"68":167244,"67":51636,"39":76733,"291":583,"8":4298,"5":4301,"422":7236,"437":7237,"438":7234,"801":222545,"794":222473,"753":222471,"150":980,"728":979,"148":981,"146":982,"544":222289,"385":1445,"780":222492,"514":222302,"1142":169213,"312":222604,"1141":222603,"523":222303,"392":222266,"779":222491,"577":9084,"170":35217,"737":222398,"729":222576,"730":222575,"281":7901,"280":222141,"628":6848,"762":6849,"227":13735,"734":222423,"706":222408,"750":222547,"361":222634,"296":222404,"416":20138,"758":167336,"757":167335,"735":222467,"297":222405,"55":47794,"56":47817,"764":222551,"765":222550,"802":222573,"803":222572,"1016":75006,"752":204332,"197":28350,"733":222541,"317":222394,"707":222618,"744":222208,"745":222207};
    
    const dbConfig = {
        user: process.env.MONGO_IMPORT_USER,
        pass: process.env.MONGO_IMPORT_PASSWORD,
        useNewUrlParser: true,
        useUnifiedTopology: true,
        useFindAndModify: false
    }
    
    const StopModel = timetableDb.model('Stop');
    
    mongoose.connect(process.env.MONGO_GTFS_URL, dbConfig);
    
    await gtfs.import({
      "agencies": [
        {
          "agency_key": "Microgiz",
          "url": "http://track.ua-gis.com/gtfs/lviv/static.zip",
          "exclude": [

          ]
        }
      ]
    });
    
    let importedStops = await gtfs.getStops();
    let stopIds = [];

    for (stopRow of importedStops) {
        let code = stopRow.stop_name.match(/(\([\-\d]+\))/i);

        if (null === code) {
            code = stopRow.stop_code
        } else if (Array.isArray(code)) {
            code = code[0]
        }

        for (cleaner of ['(', ')']) {
            code = code.replace(cleaner, '')
        }
        code = Number(code);

        if (!code) {
            console.warn(stopRow);
            continue;
        }

        let stop_name = stopRow.stop_name;

        for (cleaner of [`00${code}`, `0${code}`, code, '()', '" "', '(Т6)', '(0)', 'уточнити' , /^"{1}/ , /\s+$/, "\\"]) {
            stop_name = stop_name.replace(cleaner, '')
        }
        stop_name = stop_name.replace('""', '"')

        let stopModel = await StopModel.findOneAndUpdate(
            {code: code}, 
            {
                code: code,
                name: stop_name,
                microgiz_id: stopRow.stop_id,
                location: {
                    type: "Point",
                    coordinates: stopRow.loc
                }
            },
            {upsert: true, new: true}
        );

        // Because we could change that manually in database
        if (!stopModel.easyway_id) {
            stopModel.easyway_id = easyway_map[code.toString()] || false;
        }

        console.log(`Saved stop ${stopModel.code} - ${stopModel.name}`);
        stopIds.push(stopModel.id);
    }

    await StopModel.deleteMany({"_id" : { $nin : stopIds}})

    mongoose.connection.close()

    res.send('Ok');
}